/* CloudMine JavaScript Library v0.9 cloudmine.me | cloudmine.me/license */(function(){function e(e){this.options=y(this,e)}function t(e){this.config=_({},i,e),this._events={},this.additionalData=this.config.callbackData,this.data=null,this.hasErrors=!1,this.requestData=this.config.data,this.requestHeaders={"X-CloudMine-ApiKey":this.config.apikey,"X-CloudMine-Agent":"JS/0.9"},this.responseHeaders={},this.responseText=null,this.status=null,this.type=this.config.type||"GET";var n=M(b(this.config.options,this.config.query)),r="/",s=this.config.options.session_token,o=this.config.options.applevel;if(o===!1||o!==!0&&s!=null)r="/user/",s!=null&&(this.requestHeaders["X-CloudMine-SessionToken"]=s);this.config.headers=_(this.requestHeaders,this.config.headers),this.setContentType(e.contentType||"application/json"),this.url=[I,"/v1/app/",this.config.appid,r,this.config.action,n?"?"+n:""].join("");var u=this,a=this.config;this.config.complete=function(e,n){var r;if(e){r=e.responseText,u.status=e.status,u.responseText=r,S(e.getAllResponseHeaders().split("\n"),function(e){var t=e.indexOf(":");t>0&&(u.responseHeaders[e.substring(0,t)]=e.substring(t+2))});try{u.data=JSON.parse(r||"{}")}catch(i){u.data=r}}else u.status="abort",u.data=[a.data];n=="success"&&u.status>=200&&u.status<300?r=a.processResponse.call(u,u.data,e,u):(r={errors:{}},N(u.data)&&(u.data={errors:[u.data]}),r.errors[u.status]=u.data),setTimeout(function(){t.complete(u,r)},1)},!this.config.later&&this.config.async&&setTimeout(function(){u.xhr=j(u.url,a)},1)}function n(e,t){t=t||{},this.status=400,this.responseText=[],this._headers={};var n=F.parse(e);n.agent=!1,n.method=t.type,n.headers=t.headers||{},T(t.data)&&t.processData&&(t.data=JSON.stringify(t.data)),k(t.data)?n.headers["content-length"]=p.byteLength(t.data):N(t.data)&&(n.headers["content-length"]=t.data.length);var r=this,i=t.context||this;this._textStatus="success",this._request=(n.protocol==="http:"?H:B).request(n,function(e){e.setEncoding(t.encoding||"utf8"),e.on("data",function(e){r.responseText.push(e)}),e.on("close",function(){e.emit("end")}),e.on("end",function(){r._headers=M(e.headers),r.status=e.statusCode;var n=r.responseText=r.responseText.join("");if(t.dataType=="json"||t.dataType!="text"&&e.headers["content-type"].match(/\bapplication\/json\b/i))try{n=JSON.parse(n)}catch(s){r._textStatus="parsererror"}r._textStatus=="success"&&r.status>=200&&r.status<300?t.success&&t.success.call(i,n,"success",r):t.error&&t.error.call(i,r,"error",r.responseText),t.complete&&t.complete.call(i,r,r._textStatus)})}),this._request.on("error",function(e){r.status=e.status,r.responseText=e.message,r._textStatus="error",t.error&&t.error.call(i,r,"error",e.message),t.complete&&t.complete.call(i,r,"error")}),this._request.end(t.data)}function m(){return Math.round(Math.random()*16).toString(16)}function g(){var e=Array(32),t;e[14]=4,e[19]=(Math.round(Math.random()*16)&3|8).toString(16);for(t=0;t<14;++t)e[t]=m();for(t=15;t<19;++t)e[t]=m();for(t=20;t<32;++t)e[t]=m();return e.join("")}function y(e,t){return _({},e.options,t)}function b(e,t){var n,i;t==null&&(t={});for(n in r)i=r[n],e[n]!=null&&(t[i]=e[n]);return t}function w(e,t,n){return x(e,function(e){return(!t||e[0]==t)&&(!n||n==e[1])})}function E(e,t,n){return Array.prototype.slice.call(e,t,n)}function S(e,t,n){n=n||this;if(k(e))if(e.forEach)e.forEach(t,n);else for(var r=0;r<e.length;++r){var i=e[r];i!=null&&t.call(n,i,s,n)}else if(T(e))for(var s in e){var i=e[s];i!=null&&t.call(n,i,s,n)}}function x(e,t,n){var r=null;return n=n||this,k(e)?e.filter?r=e.filter(t,n):(r=[],S(e,function(e,n,i){t.apply(this,arguments)&&r.push(e)})):(r={},S(e,function(e,n,i){t.apply(this,arguments)&&(r[n]=e)})),r}function T(e){return e&&typeof e=="object"}function N(e){return e&&typeof e=="string"}function C(e){return T(e)&&v.indexOf(e.constructor)>-1}function k(e){return T(e)&&e.length!=null}function L(e){return typeof e=="function"}function A(e){if(e)for(var t in e)if(e.hasOwnProperty(t))return!1;return!0}function O(e,t){var n;t||(t=u),e=new Uint8Array(e);try{n=new Blob(e,{type:t})}catch(r){var i=new c;i.append(e),n=i.getBlob(t)}return n}function M(e,t,n,r){var i=[];t=t||"=";var s=r?function(e){return e}:a;for(var o in e)e[o]!=null&&!L(e[o])&&i.push(s(o)+t+s(e[o]));return i.join(n||"&")}function _(e){for(var t=1;t<arguments.length;++t)S(arguments[t],function(t,n,r){t!=null&&(e[n]=t)});return e}function D(){throw new Error("Unsupported operation","cloudmine.js")}function P(e,t){return new n(e,t)}e.prototype={get:function(e,n){return n=y(this,n),e={keys:k(e)?e.join(","):e},new t({action:"text",appid:this.options.appid,apikey:this.options.apikey,type:"GET",options:n,query:b(n,e)})},update:function(e,n,r){if(T(e))r=n;else{e||(e=g());var i={};i[e]=n,e=i}return r=y(this,r),new t({action:"text",type:"POST",appid:this.options.appid,apikey:this.options.apikey,options:r,query:b(r),data:JSON.stringify(e)})},set:function(e,n,r){if(T(e))r=n;else{e||(e=g());var i={};i[e]=n,e=i}return r=y(this,r),new t({action:"text",type:"PUT",appid:this.options.appid,apikey:this.options.apikey,options:r,query:b(r),data:JSON.stringify(e)})},destroy:function(e,n){return n=y(this,n),e==null&&n.all===!0?e={all:!0}:e={keys:k(e)?e.join(","):e},new t({action:"data",type:"DELETE",appid:this.options.appid,apikey:this.options.apikey,options:n,query:b(n,e)})},search:function(e,n){return n=y(this,n),e={q:e!=null?e:""},new t({action:"search",type:"GET",appid:this.options.appid,apikey:this.options.apikey,query:b(n,e),options:n})},searchFiles:function(e,t){e=e||"";var n='[__type__ = "file"';if(e.match(/^\[(.*?)\](.*)/)){var r=RegExp.$1;r.length>0&&(n+=", "+r),n+="]"+RegExp.$2}else e.length>0?n+="]."+e:n+="]";return this.search(n,t)},upload:function(e,n,r){function s(e,n){r.contentType||(r.contentType=n||u),t.binaryUpload(i,e,r.filename,r.contentType).done()}r=y(this,r),r.filename||(r.filename=e),e||(e=g());var i=new t({action:"binary/"+e,type:"post",later:!0,encoding:"binary",options:r,appid:r.appid,apikey:r.apikey,processResponse:t.basicResponse});if(N(n)||p&&n instanceof p)j==P?(N(n)&&(n=require("fs").readFileSync(n)),s(n)):D();else if(n.toDataURL)s(n,"image/png");else if(d&&n instanceof d)s(n.canvas,"image/png");else if(C(n)){var o=new l;o.onabort=function(){i.setData("FileReader aborted").abort()},o.onerror=function(e){i.setData(e.target.error).abort()},o.onload=function(e){s(e.target.result)},f&&n instanceof f?!r.contentType&&n.type!=""&&(r.contentType=n.type):n=O(n,r.contentType||u),o.readAsDataURL(n)}else D();return i},download:function(e,n){n=y(this,n);var r={success:{}},i;n.filename&&(i={force_download:!0,apikey:n.apikey,session_token:n.session_token,filename:n.filename});var s=new t({action:"binary/"+e,type:"GET",later:!0,encoding:"binary",options:n,query:i,appid:n.appid,apikey:n.apikey});if(n.filename){if(j==P)s.setProcessor(function(t){return r.success[e]=require("fs").writeFileSync(n.filename,t,"binary"),r}).done();else{function o(){u.parentNode&&document.body.removeChild(u)}var u=document.createElement("iframe");u.style.display="none",u.src=s.url,u.onload=o,o.timer=setTimeout(o,6e4),document.body.appendChild(u),r.success[e]=u}s.done(r)}else n.mode==="buffer"&&(h||p)?s.setProcessor(function(t){var n;if(p)n=new p(t,"binary");else{n=new h(t.length);var i=new Uint8Array(n);for(var s=0;s<t.length;++s)i[s]=t[s]&255}return r.success[e]=n,r}).done():s.setProcessor(function(t){return r.success[e]=t,r}).done();return s},createUser:function(e,n,r){T(e)?r=n:e={userid:e,password:n},r=y(this,r),r.applevel=!0;var i=JSON.stringify({email:e.userid,password:e.password});return new t({action:"account/create",type:"POST",appid:this.options.appid,apikey:this.options.apikey,options:r,processResponse:t.basicResponse,data:i})},changePassword:function(e,n,r,i){T(e)?i=n:e={userid:e,oldpassword:n,password:r},i=y(this,i),i.applevel=!0;var s=JSON.stringify({password:e.password});return new t({action:"account/password/change",type:"POST",appid:this.options.appid,apikey:this.options.apikey,data:s,options:i,processResponse:t.basicResponse,headers:{Authorization:"Basic "+q.encode(e.userid+":"+e.oldpassword)}})},resetPassword:function(e,n){n=y(this,n),n.applevel=!0;var r=JSON.stringify({email:e});return new t({action:"account/password/reset",type:"POST",appid:this.options.appid,apikey:this.options.apikey,options:n,processResponse:t.basicResponse,data:r})},confirmReset:function(e,n,r){r=y(this,r),r.applevel=!0;var i=JSON.stringify({password:n});return new t({action:"account/password/reset/"+e,type:"POST",appid:this.options.appid,apikey:this.options.apikey,data:i,processResponse:t.basicResponse,options:r})},login:function(e,n,r){T(e)?r=n:e={userid:e,password:n},this.options.userid=null,this.options.session_token=null,r=y(this,r),r.applevel=!0;var i=this;return(new t({action:"account/login",type:"POST",appid:this.options.appid,apikey:this.options.apikey,options:r,headers:{Authorization:"Basic "+q.encode(""+e.userid+":"+e.password)},processResponse:t.basicResponse})).on("success",function(e){i.options.userid=e.userid,i.options.session_token=e.session_token})},logout:function(e){e=y(this,e),e.applevel=!0;var n=this.options.session_token;return this.options.userid=null,this.options.session_token=null,new t({action:"account/logout",type:"POST",appid:this.options.appid,apikey:this.options.apikey,processResponse:t.basicResponse,headers:{"X-CloudMine-SessionToken":n},options:e})},verify:function(e,n,r){return T(e)?y=n:e={userid:e,password:n},r=y(this,r),r.applevel=!0,new t({action:"account/login",type:"POST",appid:this.options.appid,apikey:this.options.apikey,processResponse:t.basicResponse,headers:{Authorization:"Basic "+q.encode(e.userid+":"+e.password)},options:r})},isLoggedIn:function(){return!!this.options.session_token},getUserID:function(){return this.options.userid},getSessionToken:function(){return this.options.session_token},getOption:function(e){return r[e]?this.options[e]:null},setOption:function(e,t){return r[e]?(this.options[e]=t,!0):!1},useApplicationData:function(e){this.options.applevel=e===!0||e===!1?e:undefined},isApplicationData:function(){return this.options.applevel===!0||this.options.applevel===!1?this.options.applevel:this.options.session_token==null}},t.prototype={on:function(e,t,n){if(L(t)){n=n||this,this._events[e]||(this._events[e]=[]);var r=this;this._events[e].push([t,n,function(){r.off(e,t,n),t.apply(this,arguments)}])}return this},trigger:function(e){var t=this._events[e];if(t!=null){var n=E(arguments,1);S(t,function(e){e[2].apply(e[1],n)})}return this},off:function(e,t,n){return e==null&&t==null&&n==null?this._events={}:e==null?S(this._events,function(e,r,i){i._events[r]=w(e,t,n)}):this._events[e]=w(this._events[e],t,n),this},setContentType:function(e){return e=e||u,this.config&&(this.config.contentType=e,this.requestHeaders["content-type"]=e,this.config.headers["content-type"]=e),this},abort:function(){return this.xhr?(this.xhr.abort(),this.xhr=undefined,delete this.xhr):this.config&&(this.config.complete.call(this,this.xhr,"abort"),this.config=undefined,delete this.config),this},setData:function(e){return!this.xhr&&this.config&&(this.config.data=e),this},setProcessor:function(e){return!this.xhr&&this.config&&(this.config.processResponse=e),this},done:function(e){if(!this.xhr&&this.config)if(e){this.xhr=!0;var n=this;setTimeout(function(){t.complete(n,e),n.config=undefined,delete n.config},1)}else this.xhr=j(this.url,this.config),this.config=undefined,delete this.config;return this}},t.complete=function(e,t){t.errors&&(e.hasErrors=!0),e.config&&(e.config=undefined,delete e.config),e.xhr&&(e.xhr=undefined,delete e.xhr),t.success&&(s[e.status]&&e.trigger(s[e.status],t.success,e,e.status),e.trigger(e.status,t.success,e,e.status),e.trigger("success",t.success,e)),t.meta&&e.trigger("meta",t.meta,e),t.result&&e.trigger("result",t.result,e);if(t.errors){for(var n in t.errors)s[n]&&e.trigger(s[n],t.errors[n],e,n),e.trigger(n,t.errors[n],e,n);e.trigger("error",t.errors,e)}e.trigger("complete",t,e)},t.textResponse=function(e,t,n){var r={};if(e.success||e.errors||e.meta||e.result){e.count!=null&&(n.count=e.count),A(e.success)||(r.success=e.success),A(e.meta)||(r.meta=e.meta),A(e.result)||(r.result=e.result);if(!A(e.errors)){r.errors={};for(var i in e.errors){var s=e.errors[i];r.errors[s.code]||(r.errors[s.code]={}),r.errors[s.code][i]={errors:[s]}}}A(r)&&(this.config.options&&this.config.options.snippet?r.result={}:r.success={})}else r={success:e};return r},t.basicResponse=function(e,t,n){var r={success:{}};return r.success=e,r},t.binaryUpload=function(e,t,n,r){var i=g();return p&&t instanceof p?(t=t.toString("base64"),r||(r=u)):(t.toDataURL&&(t=t.toDataURL(r)),t=t.replace(/^data:(.*?);?base64,/,""),r||(r=RegExp.$1||u)),e.setContentType("multipart/form-data; boundary="+i),e.setData(["--"+i,'Content-Disposition: form-data; name="file"; filename="'+n+'"',"Content-Type: "+r,"Content-Transfer-Encoding: base64","",t,"--"+i+"--"].join("\r\n"))},n.prototype={getResponseHeader:function(e){return this._headers[e]},getAllResponseHeaders:function(){return M(this._headers,": ","\n")},abort:function(){this._request&&(this._textStatus="abort",this._request.abort(),this._request=undefined,delete this._request)}};var r={limit:"limit",skip:"skip",snippet:"f",params:"params",dontwait:"async",resultsonly:"result_only",count:"count"},i={async:!0,later:!1,processData:!1,dataType:"text",processResponse:t.textResponse,crossDomain:!0,cache:!1},s={200:"ok",201:"created",400:"badrequest",401:"unauthorized",404:"notfound",409:"conflict",500:"servererror"},o=this.window?window:root,u="application/octet-stream",a=o.encodeURIComponent||escape,f=o.File,l=o.FileReader,c=o.BlobBuilder||o.WebKitBlobBuilder||o.MozBlobBuilder||o.MSBlobBuilder,h=o.ArrayBuffer,p=o.Buffer,d=o.CanvasRenderingContext2D,v=[f,p,d,h,o.Uint8Array,o.Uint8ClampedArray,o.Uint16Array,o.Uint32Array,o.Int8Array,o.Int16Array,o.Int32Array,o.Float32Array,o.Float64Array],H,B,j,F,I="https://api.cloudmine.me";if(!this.window)j=P,F=require("url"),H=require("http"),B=require("https"),module.exports=e;else{window.cloudmine=window.cloudmine||{},window.cloudmine.WebService=e,window.cloudmine.API&&(I=window.cloudmine.API);if(($=this.jQuery||this.Zepto)==null)throw new Error("Missing jQuery-compatible ajax implementation","cloudmine.js");j=$.ajax}var q={_keyStr:"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=",encode:function(e){var t="",n,r,i,s,o,u,a,f=0;e=q._utf8_encode(e);while(f<e.length)n=e.charCodeAt(f++),r=e.charCodeAt(f++),i=e.charCodeAt(f++),s=n>>2,o=(n&3)<<4|r>>4,u=(r&15)<<2|i>>6,a=i&63,isNaN(r)?u=a=64:isNaN(i)&&(a=64),t+=this._keyStr.charAt(s)+this._keyStr.charAt(o)+this._keyStr.charAt(u)+this._keyStr.charAt(a);return t},decode:function(e){e=e.replace(/[^A-Za-z0-9\+\/\=]/g,"");var t="",n,r,i,s,o,u,a,f=0;while(f<e.length)s=this._keyStr.indexOf(e.charAt(f++)),o=this._keyStr.indexOf(e.charAt(f++)),u=this._keyStr.indexOf(e.charAt(f++)),a=this._keyStr.indexOf(e.charAt(f++)),n=s<<2|o>>4,r=(o&15)<<4|u>>2,i=(u&3)<<6|a,t+=String.fromCharCode(n),u!=64&&(t+=String.fromCharCode(r)),a!=64&&(t+=String.fromCharCode(i));return q._utf8_decode(t)},_utf8_encode:function(e){e=e.replace(/\r\n/g,"\n");var t="";for(var n=0;n<e.length;n++){var r=e.charCodeAt(n);r<128?t+=String.fromCharCode(r):r>127&&r<2048?(t+=String.fromCharCode(r>>6|192),t+=String.fromCharCode(r&63|128)):(t+=String.fromCharCode(r>>12|224),t+=String.fromCharCode(r>>6&63|128),t+=String.fromCharCode(r&63|128))}return t},_utf8_decode:function(e){var t="",n=0,r=c1=c2=0;while(n<e.length)r=e.charCodeAt(n),r<128?(t+=String.fromCharCode(r),n++):r>191&&r<224?(c2=e.charCodeAt(n+1),t+=String.fromCharCode((r&31)<<6|c2&63),n+=2):(c2=e.charCodeAt(n+1),c3=e.charCodeAt(n+2),t+=String.fromCharCode((r&15)<<12|(c2&63)<<6|c3&63),n+=3);return t}}})();